#!/bin/sh -e

MUSL_version=musl-1.2.0
LINUX_version=linux-5.4.23
LLVM_version=llvm-10
TOYBOX_version=toybox-HEAD
AWK_version=awk-HEAD
SBASE_version=sbase-HEAD
DASH_version=dash-0.5.10
BEARSSL_version=bearssl-HEAD
CURL_version=curl-7.68.0
BYACC_version=byacc-20191125
CURSES_version=netbsd-curses-HEAD
GNUMAKE_version=make-3.81
GNUBASH_version=bash-3.2.57

check()
{
  if ! type "$1" > /dev/null; then
    echo "ERROR: $1 not found in path!"
    exit 1
  fi
}

check curl
check git
check find
check rsync
check cmp
check python3

check clang
check clang++
check llvm-ar
check llvm-ranlib
check lld

check make
check cmake
check ninja
check bash
check nproc

SYSROOT=$PWD/sysroot
HOSTROOT=$PWD/build-host-$LLVM_version
MARCH=broadwell
NPROC=$(nproc)
LLVM_TBLGEN=$PWD/build-host-$llvm/bin/llvm-tblgen
CLANG_TBLGEN=$PWD/build-host-$llvm/bin/clang-tblgen
CFLAGS="-Os -pipe -march=$MARCH -mtune=$MARCH"
CXXFLAGS="-Os -pipe -march=$MARCH -mtune=$MARCH"

if ! test -f "config.ninja"; then
  echo "Creating config.ninja"
  touch config.ninja
  echo "# Autogenerated Configuration" >> config.ninja
  echo "#============================" >> config.ninja
  echo "musl=$MUSL_version" >> config.ninja
  echo "linux=$LINUX_version" >> config.ninja
  echo "llvm=$LLVM_version" >> config.ninja
  echo "toybox=$TOYBOX_version" >> config.ninja
  echo "awk=$AWK_version" >> config.ninja
  echo "sbase=$SBASE_version" >> config.ninja
  echo "dash=$DASH_version" >> config.ninja
  echo "bearssl=$BEARSSL_version" >> config.ninja
  echo "curl=$CURL_version" >> config.ninja
  echo "byacc=$BYACC_version" >> config.ninja
  echo "curses=$CURSES_version" >> config.ninja
  echo "gnumake=$GNUMAKE_version" >> config.ninja
  echo "gnubash=$GNUBASH_version" >> config.ninja
  echo "sysroot=$SYSROOT" >> config.ninja
  echo "march=$MARCH" >> config.ninja
  echo "nproc=$NPROC" >> config.ninja
  echo "make=$SYSROOT/opt/gnu/bin/make" >> config.ninja
  echo "cc=$SYSROOT/bin/clang" >> config.ninja
  echo "cxx=$SYSROOT/bin/clang++" >> config.ninja
  echo "yacc=$SYSROOT/bin/yacc" >> config.ninja
  echo "llvm-tblgen=$HOSTROOT/bin/llvm-tblgen" >> config.ninja
  echo "clang-tblgen=$HOSTROOT/bin/clang-tblgen" >> config.ninja
  echo "cflags=$CFLAGS" >> config.ninja
  echo "cxxflags=$CXXFLAGS" >> config.ninja
fi
